{%- macro curlies(item) -%}
{{ "{" }}{{ item }}{{ "}" }}
{%- endmacro -%}
{######################################}
{%- macro href(url, text) -%}
\href{{ "{" }}{{ url|replace("#", "\\#")|replace("%", "\\%")|replace("_", "\\_") }}{{ "}" }}{{ curlies(text) }}
{%- endmacro -%}
{######################################}
{%- macro label(text) -%}
\label{{ "{" }}{{ text }}{{ "}" }}
{%- endmacro -%}
{######################################}
{%- macro hyperlink(text) -%}
\hyperlink{{ "{" }}{{ text }}{{ "}" }}
{%- endmacro -%}
{######################################}
{%- macro hypertarget(text) -%}
\hypertarget{{ "{" }}{{ text }}{{ "}" }}
{%- endmacro -%}
{######################################}
{%- macro ndr(text) -%}
\vcdDocRef{{ "{" }}{{ text }}{{ "}" }}
{%- endmacro -%}
{######################################}
{%- macro njr(text) -%}
\vcdJiraRef{{ "{" }}{{ text }}{{ "}" }}
{%- endmacro -%}
{######################################}
{%- macro atmtc(text) -%}
\href{https://jira.lsstcorp.org/secure/Tests.jspa\#/testCase/{{ text }}{{ "}" }}{{ "{" }}{{ text }}{{ "}" }}
{%- endmacro -%}
{######################################}
{%- macro atmtp(text) -%}
\href{https://jira.lsstcorp.org/secure/Tests.jspa\#/testPlan/{{ text }}{{ "}" }}{{ "{" }}{{ text }}{{ "}" }}
{%- endmacro -%}
{######################################}
{%- macro atmcycle(text) -%}
\href{https://jira.lsstcorp.org/secure/Tests.jspa\#/testCycle/{{ text }}{{ "}" }}{{ "{" }}{{ text }}{{ "}" }}
{%- endmacro -%}
{######################################}
{%- macro citeds(text) -%}
\citeds{{ '{' }}{{ text }}{{ '}'}}
{%- endmacro -%}
{######################################}
% generated from JIRA project {{ metadata.project }}
% using template at {{ metadata.template }}.
% Collecting data for component: "{{ metadata.component }}"
% using docsteady version {{ metadata.docsteady_version }}
% Please do not edit -- update information in Jira instead
%
% This file is meant to be included in LaTeX document in order to provide:
%   - section 3: Summary Information
%   - section 4: VCD
%   - appendix A: Summary Explanations

\section{Summary Information}\label{sec:summary}

The following table provides an overview of the requirements and verification elements coverage.

% Summary of Summaries
\begin{longtable}{rp{2cm}p{1cm}p{1cm}p{1cm}p{1cm}p{1cm}p{1cm}}
 & \rotatebox[origin=l]{60}{ \textbf{Priority}  }
{% for cov in ncoverage %}
 & \rotatebox[origin=l]{60}{ \textbf{ {{ cov['name'] }} } {\scriptsize \ref{{ '{' }}{{ cov['label'] }}{{ '}' }} } }
{% endfor %}
 & \rotatebox[origin=l]{60}{ \textbf{ Total } }
\\ \toprule
\textbf{ {{metadata.component}} Requirements} & (All)
{% for cov in ncoverage %}
 & {{ sum_dict[2][cov["key"]] }}
{% endfor %}
 & \textbf{ {{ sum_dict[6][0] }} }
\\ \toprule
{% for doc, dcounts in sum_dict[3].items() %}
  {% set doc_loop = loop%}
  {% set NP = dcounts|length - 2 %}
  {% for priority, pcounts in dcounts.items() %}
    {% if priority != "count" and priority != "zAll" %}
 {% if loop.index == 1 %}{{ citeds(doc) }}{% endif %} & {{ priority }} {% for cov in ncoverage %} & {{ pcounts[cov["key"]] }} {% endfor %}
 & \textbf{ {{ pcounts.count }} }
      {% if NP == 1 %}
 \\ \hline
      {% else %}
 \\ \cdashline{2-8}
      {% endif %}
    {% endif %}
  {% endfor %}
  {% if NP > 1 %}
 & (All) {% for cov in ncoverage %} & {{ dcounts["zAll"][cov["key"]] }} {% endfor %}
 & \textbf{ {{ dcounts['count'] }} }
 \\ \hline
  {% endif %}
{% endfor %}
\textbf{ {{metadata.component}} Verification E.} & (All)
{% for cov in ncoverage %}
 & {{ sum_dict[1][ cov["key"] ] }}
{% endfor %}
 & \textbf{ {{ sum_dict[6][1] }} }
\\ \hline
\end{longtable}



The following table provides the Test Cases result summary.

\begin{longtable}{rp{1cm}p{1cm}p{1cm}p{1cm}p{1cm}}
{# \multicolumn{2}{c}{\textbf{Test Cases Results}} \\ \hline #}
{% for r in tcresults %}
& \rotatebox[origin=l]{60}{ \textbf{ {{ r["name"] }} }{\scriptsize \ref{{ '{' }}{{ r['label'] }}{{ '}' }} } }
{% endfor %}
& \rotatebox[origin=l]{60}{ \textbf{Total}}
\\ \toprule
Test Cases Results
{% for r in tcresults %}
& {{ sum_dict[0][ r["key"] ] }}
{% endfor %}
 & \textbf{ {{ sum_dict[6][2] }} } \\
\bottomrule
\end{longtable}

Note that test cases may be related to multiple requirements or verification elements,
and requirements or verification elements may be related to multiple test cases.


\subsection{Coverage Description}

\subsubsection{Fully Verified}\label{{ '{' }}{{ ncoverage[0]['label'] }}{{ '}' }}

These are the Verification Elements and Requirements, in which all related Test Cases have been successfully executed.
The last execution status for all test cases shall be \textbf{Passed} or \textbf{Passed w/Deviation}.


\subsubsection{Partially Verified}\label{{ '{' }}{{ ncoverage[1]['label'] }}{{ '}' }}

These are the Verification Elements and Requirements, in which some of the related Test Cases have been successfully executed.
The last execution status of the test cases shall be \textbf{Not Executed}, \textbf{Passed} or \textbf{Passed w/Deviation}.


\subsubsection{With Failures}\label{{ '{' }}{{ ncoverage[2]['label'] }}{{ '}' }}

These are the Verification Elements and Requirements, in which at least one of the related Test Cases
has a \textbf{Failure} as execution result.


\subsubsection{Not Verified}\label{{ '{' }}{{ ncoverage[3]['label'] }}{{ '}' }}

These are the Verification Elements and Requirements, in which all related Test Cases have not been executed.


\subsubsection{Not Covered}\label{{ '{' }}{{ ncoverage[4]['label'] }}{{ '}' }}

These are the Verification Elements and Requirements which are not related to any Test Cases.


\subsection{Test Executions Description}


\subsubsection{Passed}\label{{ '{' }}{{ tcresults[0]['label'] }}{{ '}' }}

Test cases that have been executed without any problems.
Issues may have been found during the execution, and linked to the test case, but they are not
affecting the verification process.


\subsubsection{Passed with Deviation}\label{{ '{' }}{{ tcresults[1]['label'] }}{{ '}' }}

Test cases which execution can be considered successful, but a deviation to the requirement is needed.
The deviation shall be recorded in a Jira issue, type \textit{Deviation} and linked to the test.


\subsubsection{Failed}\label{{ '{' }}{{ tcresults[2]['label'] }}{{ '}' }}

The test case execution failed. One or more Jira issues shall be filed and related with the test.


\subsubsection{Not Executed}\label{{ '{' }}{{ tcresults[3]['label'] }}{{ '}' }}

The test case has not been executed yet.


\newpage
\section{Verification Control} \label{sec:vcd}

{% for spec in spec_to_reqs %}

\subsection{{ '{' }}{{ spec }} Requirements Coverage{{ '}' }}

\setlength\LTleft{-0.25in}
\setlength\LTright{-0.5in}
{\small
{# \newlength{\LTcapwidthold}
\setlength{\LTcapwidthold}{\LTcapwidth}
\setlength{\LTcapwidth}{\textheight} #}
\begin{longtable}{lllll}
\caption{ {{ metadata.component }} {{ spec }} Requirements.} \\
\toprule
\textbf{Requirement} & \textbf{Verification Element} & \textbf{Test Case} & \textbf{Last Run} & \textbf{Test Status} \\
\toprule
\endhead
{# {% for req in vcd_dict[1] %} #}
{% for req in spec_to_reqs[spec] %}
  \begin{tabular}{@{}l@{}}
  {{ req }}\\{{ ndr(vcd_dict[1][req]['reqDoc']) }}~{\tiny (p. {{ vcd_dict[1][req]['priority'] }})}
  \end{tabular} &
  {% set nve = vcd_dict[1][req]['VEs']| length %}
  {% for ve in vcd_dict[1][req]['VEs'] %}
    {% if loop.index != 1 %}
      &
    {% endif %}
    \begin{tabular}{@{}l@{}}
    {{ hypertarget(ve.lower()) }}{{ curlies(ve) }}
    \\{{ njr(vcd_dict[0][ve]['jkey']) }}~{\tiny (p. {{ vcd_dict[0][ve]['priority'] }})}
    \end{tabular} &
    {% set ntc = vcd_dict[0][ve]['tcs']| length %}
    {% set ntby = 0 %}
    {% if vcd_dict[0][ve]['verifiedby'] %}
        \multicolumn{3}{c}{
        \begin{tabular}{ r l }
        Verified in: &
        {% for vby in vcd_dict[0][ve]['verifiedby'] %}
            {% if loop.index != 1 %}
               &
            {% endif %}
            {{ hyperlink(vby.lower()) }}{{ curlies(vby) }}({{ njr(vcd_dict[0][vby]['jkey']) }})\\
        {% endfor %}
        \end{tabular}
        } \\
        {% set ntby = vcd_dict[0][ve]['verifiedby']| length %}
        {% if ntc != 0 %}
          \cmidrule{3-5}
        {% endif %}
    {% endif %}
    {% if ntc == 0 %}
      {% if ntby == 0 %}
        & & \\
      {% endif %}
    {% else %}
      {% for tc in vcd_dict[0][ve]['tcs'] %}
        {% if (loop.index != 1 or ntby != 0) %}
          & &
        {% endif %}
        \begin{tabular}{@{}l@{}}
        {{ atmtc(tc) }} \\
        {{ ndr(vcd_dict[0][ve]['tcs'][tc]['tspec']) }}
        \end{tabular} &
        {% if vcd_dict[3][tc]['lastR'] %}
          \begin{tabular}{@{}l@{}}
          {{ vcd_dict[3][tc]['lastR']['exdate'] }} \\
          {% set tpl = vcd_dict[3][tc]['lastR']['tplan'] %}
          {% if tpl != "NA" %}
            {{ ndr(vcd_dict[3][tc]['lastR']['dmtr']) }}
            {\scriptsize {{ atmtp(tpl) }} }
          {% else %}
            {\scriptsize {{ atmcycle(vcd_dict[3][tc]['lastR']['tcycle']) }} }
          {% endif %}
          \end{tabular} &
          \{{ vcd_dict[3][tc]['lastR']['status'] }} \\
        {% else %}
          & \notexec{} \\
        {% endif %}
        {% if loop.index != ntc %}
          \cmidrule{3-5}
        {% endif %}
      {% endfor %}
    {% endif %}
    {% if loop.index != nve %}
      \cmidrule{2-5}
    {% endif %}
  {% endfor %}
  \midrule
{% endfor %}
\label{tab:dmvcd}
\end{longtable}
}

{% endfor %}

